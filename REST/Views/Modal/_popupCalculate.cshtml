<!-- Modal Calculate -->
<style>
    .calc_btn_row{
        display: flex;
        align-content: stretch;
        justify-content: space-between;
        margin-bottom: 0.8%;
    }

    .calc_btn{
        background-color: #d8d8d8;
        color: #000;
        font-weight: bold;
        font-size: 1.5rem;
        border: none;
        height: 70px;
        flex-basis: 24.5%;
        cursor: pointer;
    }

    .calc_btn:hover{
        background-color: #ebebeb;
    }

    .calc_btn:active{
        background-color: #bbbcbe;
    }

    .bath {
        background-color: #df974c;
        color: #fff;
        font-size: 0.9rem;
        border: none;
        height: 70px;
        flex-basis: 24.5%;
        cursor: pointer;
    }

    .bath:hover {
        background-color: #dfb07e;
    }
   
    .coupon {
        background-color: #4caedf;
        color: #fff;
        font-size: 0.9rem;
        border: none;
        height: 70px;
        flex-basis: 24.5%;
        cursor: pointer;
    }

    .coupon:hover {
        background-color: #4cb5df;
    }

    .print {
        background-color: #07a832;
        color: #fff;
        font-size: 0.9rem;
        border: none;
        height: 70px;
        flex-basis: 24.5%;
        cursor: pointer;
    }

    .print:hover {
        background-color: #06b835;
    }

    .out {
        background-color: red;
        color: #fff;
        font-size: 0.9rem;
        border: none;
        height: 70px;
        flex-basis: 100%;
        cursor: pointer;
    }

    .out:hover {
        background-color: #de0d0d;
    }

    .double {
        flex-basis: 49.7%;
    }
</style>

<div class="modal fade" id="popupCalculate" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="popupCalculateTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <!-- Left -->
                        <div class="col-md-7">
                            <div class="form-group mt-2 mb-0 row">
                                <label class="col-5 col-form-label font-weight-bold text-right">จำนวนเงิน :</label>
                                <div class="col-7">
                                    <input id="txtSum" type="text" readonly class="form-control-plaintext form-control-lg text-right border-bottom" placeholder="0.00" style="font-weight: bold;">
                                </div>
                            </div>
                            <div class="form-group mb-0 row">
                                <label class="col-5 col-form-label font-weight-bold text-right">ส่วนลดคูปอง :</label>
                                <div class="col-7">
                                    <input id="txtCoupon" type="text" class="form-control-plaintext form-control-lg numberonly text-right border-bottom text-muted" placeholder="0.00" style="font-weight: bold;">
                                </div>
                            </div>
                            <div class="form-group mb-0 row">
                                <label class="col-5 col-form-label font-weight-bold text-right">จำนวนเงินชำระ :</label>
                                <div class="col-7">
                                    <input id="txtTotal" type="text" class="form-control-plaintext form-control-lg text-right border-bottom" placeholder="0.00" style="font-weight: bold;">
                                </div>
                            </div>
                            <p class="font-weight-bold col-form-label-sm text-center mt-3 border-bottom">ชำระเงินโดย</p>
                            <div class="form-group mb-1 row">
                                <div class="col-4 ml-4">
                                    <input class="form-check-input mt-2" type="checkbox" id="cash1" checked>
                                    <label class="form-check-label col-form-label-sm" for="cash1">
                                        เงินสด
                                    </label>
                                </div>
                                <div class="col"><input id="txtCash1" type="text" class="form-control form-control-sm text-right numberonly" placeholder="0.00"></div>
                            </div>
                            <!-- ยอดเงินปัดเศษ -->
                            @*<div class="form-group mb-1 row">
            <div class="col-4 ml-4 text-right">
                <label class="form-check-label col-form-label-sm">
                    ยอดเงินปัดเศษ :
                </label>
            </div>
            <div class="col">
                <input type="text" id="txtOver" class="form-control form-control-sm text-right" placeholder="0.00">
            </div>
        </div>*@
                            <div class="form-group row">
                                <div class="col-4 ml-4 text-right">
                                    <label class="form-check-label col-form-label-sm">
                                        เงินทอน :
                                    </label>
                                </div>
                                <div class="col">
                                    <input type="text" id="txtChang" class="form-control form-control-sm text-right" readonly placeholder="0.00">
                                </div>

                            </div>
                            <hr />
                            <div class="form-group row">
                                <div class="col-4 ml-4">
                                    <input class="form-check-input mt-2" type="checkbox" id="cash2">
                                    <label class="form-check-label col-form-label-sm" for="cash2">
                                        เงินโอน
                                    </label>
                                </div>
                                <div class="col">
                                    <div class="input-group input-group-sm">
                                        <input id="txtCash2" type="text" class="form-control form-control-sm text-right numberonly" placeholder="0.00">
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" type="button" btn-transfer><i class="fas fa-shekel-sign"></i></button>
                                        </div>
                                    </div>                                    
                                </div>
                            </div>
                            <hr />
                            <div class="form-group mb-1  row">
                                <div class="col-4 ml-4">
                                    <input class="form-check-input mt-2" type="checkbox" id="cash3">
                                    <label class="form-check-label col-form-label-sm" for="cash3">
                                        Credit & Debit
                                    </label>
                                </div>
                                <div class="col">
                                    <div class="input-group input-group-sm">
                                        <input id="txtCash3" type="text" class="form-control form-control-sm text-right numberonly" placeholder="0.00">
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" type="button" btn-credit><i class="far fa-credit-card"></i></button>
                                        </div>
                                    </div>                                    
                                </div>
                            </div>
                            <div class="form-group mb-1 row">
                                <div class="col-4 ml-4 text-right">
                                    <label class="form-check-label col-form-label-sm" for="autoSizingCheck">
                                        Card Type :
                                    </label>
                                </div>
                                <div class="col">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Cash3Type" id="T1" value="1" disabled>
                                        <label class="form-check-label" for="T1"><img src="~/Images/System/Svg/VISA.svg" width="40" height="30" alt="" loading="lazy"></label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Cash3Type" id="T2" value="2" disabled>
                                        <label class="form-check-label" for="T2"><img src="~/Images/System/Svg/MASTERCARD.svg" width="40" height="30" alt="" loading="lazy"></label>
                                    </div>
                                </div>

                            </div>
                            <div class="form-group mb-1 row">
                                <div class="col-4 ml-4 text-right">
                                    <label class="form-check-label col-form-label-sm" for="autoSizingCheck">
                                        Number :
                                    </label>
                                </div>
                                <div class="col">
                                    <div class="input-group input-group-sm">
                                        <div class="input-group-prepend">
                                            @*<button class="btn btn-secondary" type="button" ><i class="far fa-credit-card"></i></button>*@
                                            <span class="input-group-text"><i class="far fa-credit-card"></i></span>
                                        </div>
                                        <input type="text" id="txtNumberCash3" class="form-control" readonly placeholder="xxxxxxxxxxxxx">
                                    </div>
                                </div>
                            </div>
                            <hr />
                            <!-- ผลรวมทั้งหมด -->
                            <div class="form-group row">
                                <label class="col-5 col-form-label-sm font-weight-bold text-right">ผลรวมทั้งหมด :</label>
                                <div class="col-7">
                                    <input id="SUMPRICEALL" type="text" readonly class="form-control-plaintext form-control-sm text-right border-bottom" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        <!-- Right -->
                        <div class="col-md-5 ml-auto">
                            <div class="form-group mt-2">
                                <input id="txtNumberCalculate" type="text" class="form-control form-control-lg text-right text-danger bg-white" placeholder="0.00" style="font-weight: bold;">
                            </div>
                            <section class="calc-btn_row">
                                <div class="calc_btn_row">
                                    <button class="calc_btn bath" data-20>20 บาท</button>
                                    <button class="calc_btn coupon" data-coupon>คูปอง</button>
                                    <button class="calc_btn double" data-all-clear>C</button>
                                </div>
                                <div class="calc_btn_row">
                                    <button class="calc_btn bath" data-100>100 บาท</button>
                                    <button class="calc_btn" data-number>7</button>
                                    <button class="calc_btn" data-number>8</button>
                                    <button class="calc_btn" data-number>9</button>
                                </div>
                                <div class="calc_btn_row">
                                    <button class="calc_btn bath" data-500>500 บาท</button>
                                    <button class="calc_btn" data-number>4</button>
                                    <button class="calc_btn" data-number>5</button>
                                    <button class="calc_btn" data-number>6</button>
                                </div>
                                <div class="calc_btn_row">
                                    <button class="calc_btn bath" data-1000>1000 บาท</button>
                                    <button class="calc_btn" data-number>1</button>
                                    <button class="calc_btn" data-number>2</button>
                                    <button class="calc_btn" data-number>3</button>
                                </div>
                                <div class="calc_btn_row">
                                    <button class="calc_btn print double" data-print>พิมพ์ใบเสร็จ</button>
                                    <button class="calc_btn" data-number>0</button>
                                    <button class="calc_btn" data-number>.</button>
                                </div>
                                <div class="calc_btn_row">
                                    <button class="calc_btn out" data-dismiss="modal">ปิด</button>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $('#popupCalculate').on('shown.bs.modal', function () {
        const billId = $('#txtBillId').val()
        const tableId = $('#txtTableId').val()
        const memberId = $('#txtMemberId').val()
        const balance = $('#txtBalance').val()
        const servicePersen = $('#txtServiceP').val()
        const serviceBath = $('#txtServiceB').val()
        const memberPersen = $('#txtMemP').val()
        const memberBath = $('#txtMemB').val()
        const persen = $('#txtPersP').val()
        const persenBath = $('#txtPersB').val()

        $('#txtSum').val($('#txtSumBalance').val())
        $('#txtTotal').val($('#txtSumBalance').val())
        $('#txtCash1').val($('#txtSumBalance').val())
        $('#txtOver').val('0.00')
        $('#txtCash2').val('0.00')
        $('#txtCash3').val('0.00')
        $('#SUMPRICEALL').val($('#txtSumBalance').val())

        const txtsum = document.getElementById('txtSum')
        const txtcoupon = document.getElementById('txtCoupon')
        const txttotal = document.getElementById('txtTotal')
        const txtchang = document.getElementById('txtChang')

        txtcoupon.value = '0.00'
        txtchang.value = '0.00'

        const numberButton = document.querySelectorAll('[data-number]')
        const number20 = document.querySelector('[data-20]')
        const number100 = document.querySelector('[data-100]')
        const number500 = document.querySelector('[data-500]')
        const number1000 = document.querySelector('[data-1000]')
        const coupon = document.querySelector('[data-coupon]')
        const clearNumber = document.querySelector('[data-all-clear]')
        const numberCalculate = document.getElementById('txtNumberCalculate')

        numberCalculate.value = '0.00'

        document.getElementById('cash1').addEventListener('change', () => {
            if ($('#cash1').prop("checked") == false) {
                $('#txtCash1').val('0.00')
            } else {
                $('#txtCash1').val($('#txtSum').val())
            }

            CheckTypeCash('cash1')
        })

        document.getElementById('cash2').addEventListener('change', () => {
            if ($('#cash2').prop("checked") == false) {
                $('#txtCash2').val('0.00')
                $('#txtNumberCalculate').val('0.00')
            }

            CheckTypeCash('cash2')
        })

        document.getElementById('cash3').addEventListener('change', () => {
            if ($('#cash3').prop("checked") == false) {
                $('#txtCash3').val('0.00')
                $('#txtNumberCalculate').val('0.00')
            }

            CheckTypeCash('cash3')

            if ($('#cash3').prop("checked") == true) {
                $('#T1').prop('checked', true)
                $('#T1').prop('disabled', false)
                $('#T2').prop('disabled', false)
                $('#txtNumberCash3').prop('readonly', false)
            } else {          
                $('#T1').prop('checked', false)
                $('#T2').prop('checked', false)
                $('#T1').prop('disabled', true)
                $('#T2').prop('disabled', true)
                $('#txtNumberCash3').prop('readonly', true)
            }            
        })

        function CheckTypeCash(a) {
            if ($('#cash1').prop("checked") == true && $('#cash2').prop("checked") == true && $('#cash3').prop("checked") == true) {
                Swal.fire({ text: "ไม่สามารถเลือกชำระเงิน 3 อย่างได้", icon: 'warning' })
                console.log(a)
                $(`#${a}`).prop('checked', false)
                return;
            }
        }

        document.getElementById('txtNumberCalculate').addEventListener('keyup', () => {
            var t = parseFloat(numberCalculate.value.replace(/,/g, '')) - parseFloat($('#txtCash1').val().replace(/,/g, ''))
            txtchang.value = numeral(t).format('0,0.00')

            if (parseFloat(txtchang.value.replace(/,/g, '')) < 0)
                txtchang.value = numeral(0).format('0,0.00')

        })

        document.getElementById('txtCoupon').addEventListener('keyup', () => {
            var t = parseFloat(txtsum.value.replace(/,/g, '')) - parseFloat(txtcoupon.value.replace(/,/g, ''))
            if (txtcoupon.value > parseFloat(txtsum.value.replace(/,/g, ''))) {
                Swal.fire({ text: "ส่วนลดคูปองมากกว่า จำนวนเงินต้องชำระ", icon: 'warning' })
                txtcoupon.value = ''
                txttotal.value = numeral(txtsum.value).format('0,0.00')
            } else {
                txttotal.value = numeral(t).format('0,0.00')
            }

        })

        document.getElementById('txtCash1').addEventListener('blur', () => {
            BlurSumCash()
        })

        document.getElementById('txtCash2').addEventListener('blur', () => {
            BlurSumCash()
        })

        document.getElementById('txtCash3').addEventListener('blur', () => {
            BlurSumCash()
        })

        function BlurSumCash() {
            let cash1 = parseFloat($('#txtCash1').val().replace(/,/g, ''))
            let cash2 = parseFloat($('#txtCash2').val().replace(/,/g, ''))
            let cash3 = parseFloat($('#txtCash3').val().replace(/,/g, ''))
            let total = cash1 + cash2 + cash3
            $('#SUMPRICEALL').val(numeral(total).format('0,0.00'))
        }

        class Calculatore {

            clear() {
                numberCalculate.value = '0.00';
                txtchang.value = '0.00'
            }

            appendNumber(number) {
                if (number == '.' && numberCalculate.value.includes('.'))
                    return;

                if (numberCalculate.value == '0.00')
                    numberCalculate.value = ''

                numberCalculate.value = numberCalculate.value.toString() + number.toString()

                txtchang.value = numeral(parseFloat(numberCalculate.value.replace(/,/g, '')) - parseFloat($('#txtCash1').val().replace(/,/g, ''))).format('0,0.00')

                if (parseFloat(txtchang.value.replace(/,/g, '')) < 0)
                    txtchang.value = numeral(0).format('0,0.00')

            }

            appendNumberPlus(number) {
                if (numberCalculate.value != "")
                    numberCalculate.value = numeral(parseFloat(numberCalculate.value.replace(/,/g, '')) + number).format('0,0.00')
                else
                    numberCalculate.value = numeral(number).format('0,0.00')

                txtchang.value = numeral(parseFloat(numberCalculate.value.replace(/,/g, '')) - parseFloat($('#txtCash1').val().replace(/,/g, ''))).format('0,0.00')

                if (parseFloat(txtchang.value.replace(/,/g, '')) < 0)
                    txtchang.value = numeral(0).format('0,0.00')
            }
        }

        const calculator = new Calculatore(numberCalculate);

        numberButton.forEach((button) => {
            button.addEventListener('click', () => {
                calculator.appendNumber(button.innerHTML)
            })

        })

        number20.addEventListener('click', () => {
            calculator.appendNumberPlus(20)
        })

        number100.addEventListener('click', () => {
            calculator.appendNumberPlus(100)
        })

        number500.addEventListener('click', () => {
            calculator.appendNumberPlus(500)
        })

        number1000.addEventListener('click', () => {
            calculator.appendNumberPlus(1000)
        })

        coupon.addEventListener('click', () => {
            $('#txtCoupon').select()
        })

        clearNumber.addEventListener('click', () => {
            calculator.clear()
        })

        document.querySelector('[btn-transfer]').addEventListener('click', () => {
            $('#cash1').prop("checked", false)
            $('#txtCash1').val('0.00')
            $('#cash2').prop("checked", true)
            $('#txtCash2').val($('#txtSum').val())
            $('#txtNumberCalculate').val($('#txtSum').val())
            $('#cash3').prop("checked", false)
            $('#txtCash3').val('0.00')            
            $('#T1').prop('checked', false)
            $('#T2').prop('checked', false)
            $('#T1').prop('disabled', true)
            $('#T2').prop('disabled', true)
            $('#txtNumberCash3').prop('readonly', true)
        }) 

        document.querySelector('[btn-credit]').addEventListener('click', () => {
            $('#cash1').prop("checked", false)
            $('#txtCash1').val('0.00')
            $('#cash2').prop("checked", false)
            $('#txtCash2').val('0.00')            
            $('#cash3').prop("checked", true)
            $('#txtCash3').val($('#txtSum').val())
            $('#txtNumberCalculate').val($('#txtSum').val())
            $('#T1').prop('checked', true)
            $('#T1').prop('disabled', false)
            $('#T2').prop('disabled', false)
            $('#txtNumberCash3').prop('readonly', false)
        }) 

        document.querySelector('[data-print]').addEventListener('click', () => {            

            if ($('#cash1').prop("checked") == true) {
                if ($('#txtCash1').val() == '' || $('#txtCash1').val() == 0) {
                    Swal.fire({ text: "กรุณากรอกจำนวนเงินสด", icon: 'warning' })                    
                    return;
                }

                if ($('#txtNumberCalculate').val() == '' || $('#txtNumberCalculate').val() == 0) {
                    Swal.fire({ text: "กรุณากรอกจำนวนเงิน", icon: 'warning' }, $('#txtNumberCalculate').select())                    
                    return;
                }
            }

            if ($('#cash2').prop("checked") == true) {
                if ($('#txtCash2').val() == '' || $('#txtCash2').val() == 0) {
                    Swal.fire({ text: "กรุณากรอกจำนวนเงินโอน", icon: 'warning' })
                    return;
                }
            }

            if ($('#cash3').prop("checked") == true) {
                if ($('#txtCash3').val() == '' || $('#txtCash3').val() == 0) {
                    Swal.fire({ text: "กรุณากรอกจำนวนเงินบัตรเครดิต", icon: 'warning' })
                    return;
                    if ($('#txtNumberCash3').val() == '') {
                        Swal.fire({ text: "กรุณากรอกเลขบัตรเครดิต", icon: 'warning' })
                        return;
                    }
                }
            }

            if ($('#cash1').prop("checked") == false && $('#cash2').prop("checked") == false && $('#cash3').prop("checked") == false) {
                Swal.fire({ text: "กรุณาเลือกการชำระเงิน", icon: 'warning' })
                return;
            }

            // ถ้าเงินสดอย่างเดียว
            if ($('#cash1').prop("checked") == true && $('#cash2').prop("checked") == false && $('#cash3').prop("checked") == false) {
                $('#txtCash1').val($('#txtSum').val())
                $('#txtNumberCalculate').val($('#txtSum').val())
            }

            // ถ้าเงินโอนอย่างเดียว
            if ($('#cash1').prop("checked") == false && $('#cash2').prop("checked") == true && $('#cash3').prop("checked") == false) {
                $('#txtCash2').val($('#txtSum').val())
                $('#txtNumberCalculate').val($('#txtSum').val())
            }

            // ถ้าเงินบัตรเครดิตอย่างเดียว
            if ($('#cash1').prop("checked") == false && $('#cash2').prop("checked") == false && $('#cash3').prop("checked") == true) {
                $('#txtCash3').val($('#txtSum').val())
                $('#txtNumberCalculate').val($('#txtSum').val())
            }

            if (parseFloat($('#SUMPRICEALL').val().replace(/,/g, '')) != parseFloat($('#txtTotal').val().replace(/,/g, ''))) {
                Swal.fire({ text: "จำนวนเงินที่ชำระไม่ถูกต้อง", icon: 'warning' })
                return;
            }

            var data = new FormData();
            data.append('BillId', billId);
            data.append('TableId', tableId);
            data.append('MemberId', memberId);
            data.append('SumBalance', balance);
            data.append('ServicePersen', servicePersen);
            data.append('ServiceBath', serviceBath);
            data.append('MemberPersen', memberPersen);
            data.append('MemberBath', memberBath);
            data.append('Persen', persen);
            data.append('PersenBath', persenBath);
            data.append('Balance', txtsum.value);
            data.append('Coupon', txtcoupon.value);
            data.append('Total', txttotal.value);
            data.append('MoneyPut', numberCalculate.value);
            data.append('MoneyChange', txtchang.value);
            data.append('Cash1', $('#cash1').prop("checked"));
            data.append('Cash1Bath', $('#txtCash1').val());
            data.append('Cash2', $('#cash2').prop("checked"));
            data.append('Cash2Bath', $('#txtCash2').val());
            data.append('Cash3', $('#cash3').prop("checked"));
            data.append('Cash3Bath', $('#txtCash3').val());

            if ($('#T1').prop('checked') == true) {
                data.append('Cash3Type', 1);
            } else if ($('#T2').prop('checked') == true) {
                data.append('Cash3Type', 2);
            } else {
                data.append('Cash3Type', 0);
            }
            
            data.append('Cash3Number', $('#txtNumberCash3').val());

            $.ajax({
                type: 'POST',
                url: '@Url.Action("FrmPayment", "SF_Payment")',
                contentType: false,
                processData: false,
                data: data,
                success: function (data) {
                    $.each(data, function (index, val) {
                        if (val == "success") {
                            window.location.href = '@Url.Action("Index", "StoreFront")'
                        } else if (val == "errorSumBalance") {
                            Swal.fire({ text: "กรุณาเช็คบิลก่อน", icon: 'warning' })
                        } else if (val == "errorDate") {
                            Swal.fire({ text: "วันที่ไม่ตรงกัน", icon: 'warning' })
                        } else {
                            Swal.fire({ text: "ไม่สามารถบันทึกข้อมูลได้", icon: 'warning'} )
                        }
                    })
                }
            })
        })

    })
</script>