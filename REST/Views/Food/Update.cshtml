@model CD_Food
@{ 
    ViewData["Title"] = "Food Update";
    Layout = "_StoreBack";

    var Image = "~/Images/Food/" + (Model.ImageName ?? "NOIMAGE.jpg");
}


@section Styles {
    <link rel="stylesheet" href="~/Plugins/Tail.Select/css/bootstrap4/tail.select-default.css" />
    <link rel="stylesheet" href="~/StyleSheet/Food/Insert.css" />    
    @*<link href="~/Plugins/dist/css/select2.css" rel="stylesheet" />*@
}


        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8 col-md-12 col-12 mx-auto">
                        <h5 class="text-center font-weight-bold">
                            แก้ไขอาหาร
                        </h5>
                        <hr />
                    </div>
                </div>
                <form name="Update" method="post" enctype="multipart/form-data">
                    <div class="row mb-3">
                        <div class="col-lg-8 mx-auto">
                            <div class="row">
                                <div class="col-md-5">
                                    <h6 class="text-center">รูปภาพ</h6>
                                    <hr />
                                    <!-- Uploaded image area-->
                                    <div class="image-preview mx-auto" id="image-preview">
                                        <img src="@Image" asp-append-version="true" alt="" class="image-preview__image" />
                                    </div>
                                    <div class="text-center mt-4" style="margin-bottom:5px;">
                                        <small class="text-muted">รูปภาพ<span class="text-danger">* ขนาด 250 x 250</span></small>
                                    </div>
                                    <div class="form-group">
                                        <div class="custom-file">
                                            <input asp-for="ImageFile" type="file" id="inputFile" class="custom-file-input">
                                            <label asp-for="ImageFile" class="custom-file-label" id="upload-label">เลือกรูปภาพ</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <h6 class="text-center">ข้อมูล</h6>
                                    <hr />
                                    <div class="form-group">
                                        <label>กลุ่มอาหาร :</label>
                                        <select asp-for="GroupFoodId" class="form-control" readonly>
                                            <option value="" selected>-- กรุณาเลือกกลุ่มอาหาร --</option>
                                            @foreach (var row in ViewBag.GroupFood)
                                            {
                                                <option value="@row.GroupFoodId">@row.GroupFoodName</option>
                                            }
                                        </select>
                                        <span asp-validation-for="GroupFoodId" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>รหัส :</label>
                                        <input asp-for="FoodId" type="text" id="txtFoodId" class="form-control" readonly/>
                                        <span asp-validation-for="FoodId" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>ชื่อ :</label>
                                        <input asp-for="FoodName" type="text" class="form-control" />
                                        <span asp-validation-for="FoodName" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>เครื่องเคียง :</label>
                                        <select asp-for="DishId" class="form-control">
                                            <option value="" selected>-- กรุณาเลือกเครื่องเคียง --</option>
                                            @foreach (var row in ViewBag.Dish)
                                            {
                                                <option value="@row.DishId">@row.DishName</option>
                                            }
                                        </select>
                                        <span asp-validation-for="GroupFoodId" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <label>ราคา :</label>
                                        <input asp-for="Price" type="text" class="form-control text-right" placeholder="0.00" id="txtPrice" />
                                        <span asp-validation-for="Price" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>
                            <hr />                              
                        </div>
                    </div>   
                    <div class="row">
                        <div class="col-md-2 col-sm-3 col-12 mx-auto">
                            <button type="button" onclick="SaveData()" class="btn btn-blue btn-block shadow-sm"><i class="far fa-save"></i>&nbsp;&nbsp;<span>บันทึก</span></button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="row">
                            <div class="col d-flex">
                                <h5 class="font-weight-bold"><i class="fas fa-carrot"></i>&nbsp;ข้อมูลวัตถุดิบ&nbsp;</h5>
                                <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#MadalStaple"><i class="fas fa-plus-circle"></i>&nbsp;เพิ่ม</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">

                                <div id="frmNoData">
                                    <hr />
                                    <p class="text-danger text-center">ไม่มีข้อมูลวัตถุดิบ</p>
                                    <hr />
                                </div>

                                <table class="table table-bordered mt-3" id="frmStaple">
                                    <thead style="background-color:#F8FAFD;">
                                        <tr>
                                            <th class="text-center">ชื่อ</th>
                                            <th class="text-center">จำนวน</th>
                                            <th class="text-center">หน่วยนับ</th>
                                            <th class="text-center">#</th>
                                        </tr>
                                    </thead>
                                    <tbody id="Tb_Staple">
                                        <tr>
                                            <td colspan="3" class="text-right">ลบข้อมูลทั้งหมด</td>
                                            <td class="text-center table-danger"><a href="#" class="text-white"><i class="fas fa-times"></i></a></td>
                                        </tr>
                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                </div>                
            </div>
        </div>


<!-- Modal -->
<div class="modal fade" id="MadalStaple" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="MadalStapleTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row">
                    <div class="col">
                        <h5 class="modal-title" id="exampleModalCenterTitle">ข้อมูลวัตถุดิบ</h5>
                    </div>
                    <div class="col text-right">
                        <button type="button" class="btn btn-light font-weight-bold" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
                <hr />
                <div class="row mb-3">
                    <div class="col-8">
                        <label>วัตถุดิบ :</label>
                        <select class="custom-select" id="SelStaple">
                            <option value="" selected>--กรุณาเลือก--</option>
                            @foreach (var row in ViewBag.Staple)
                            {
                                <option value="@row.StapleId">@row.StapleName</option>
                            }
                        </select>
                    </div>
                    <div class="col-4">
                        <label>จำนวน :</label>
                        <input type="number" class="form-control text-right floatNumber" value="1" id="txtAmount"/>
                    </div>
                </div>
                <hr />
                <div class="text-right mb-3">
                    <button type="button" class="btn btn-primary" onclick="AddStaple();"><i class="fas fa-folder-plus"></i>&nbsp;&nbsp;ADD</button>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="~/Plugins/Tail.Select/js/tail.select-full.min.js"></script>
    <script src="~/JavaScript/Food/Insert.js"></script>
    <script src="~/Plugins/Numeral/numeral.js"></script>    
    @*<script src="~/Plugins/dist/js/select2.min.js"></script>*@
    <script>

        $(document).ready(function () {

            tail.select("#SelStaple", {
                search: true,
            });

            //$('#SelStaple').select2();

            $(".item_click_Food").addClass("active");

            $('#frmStaple').hide();

            GetStaple()

        });

        function CheckRunning(val) {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("GetRunning", "Food")',
                data: 'id=' + val.value,
                success: function (data) {
                    if (data != null) {
                        $('#FoodId').val(data);
                        $('#FoodId').prop('readonly', true);
                    } else {
                        $('#FoodId').val(data);
                        $('#FoodId').prop('readonly', false);
                    }

                }
            });
        }

        function SaveData() {
            Swal.fire({
                text: "ต้องการบันทึกข้อมูลหรือไม่ ?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
            }).then((result) => {
                if (result.value) {
                    document.Update.action = '@Url.Action("Update", "Food")'
                    document.Update.submit();
                }
            })
        }

        function GetStaple() {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("GetStaple", "FoodSub")',
                data: { id: $('#txtFoodId').val()},
                success: function (data) {
                    $.each(data, function (index, val) {
                        if (val.length > 0) {
                            $('#Tb_Staple').empty();

                            val.forEach(function (value) {
                                var HRemove = 'onclick=Remove("' + value.stapleId + '");';
                                var t = '<tr>'
                                    + '<td>' + value.stapleName + '</td>'
                                    + '<td class="text-center">' + value.amount + '</td>'
                                    + '<td class="text-center">' + value.unitName + '</td>'
                                    + `<td class="text-center"><a href="#" ${HRemove} class="text-danger"><i class="fas fa-times"></i></a></td>`
                                    + '</tr>';
                                $('#Tb_Staple').append(t)
                            })

                            var HDelete = 'onclick=Delete();';
                            var a = '<tr>'
                                + '<td colspan = "3" class="text-right">ลบข้อมูลทั้งหมด</td >'
                                + `<td class="text-center table-danger"><a href="#" ${HDelete} class="text-white"><i class="fas fa-times"></i></a></td>`
                                + '</tr>';
                            $('#Tb_Staple').append(a)

                            $('#frmNoData').hide();
                            $('#frmStaple').show();

                        } else {
                            $('#frmNoData').show();
                            $('#frmStaple').hide();
                        }

                    })
                }
            });
        }

        function AddStaple() {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("Add", "FoodSub")',
                data: { id: $('#SelStaple').val(), Amount: $('#txtAmount').val()},
                success: function (data) {
                    $.each(data, function (index, val) {
                        if (val.length > 0) {
                            $('#Tb_Staple').empty();

                            val.forEach(function (value) {
                                var HRemove = 'onclick=Remove("' + value.stapleId + '");';
                                var t = '<tr>'
                                    + '<td>' + value.stapleName + '</td>'
                                    + '<td class="text-center">' + value.amount + '</td>'
                                    + '<td class="text-center">' + value.unitName + '</td>'
                                    + `<td class="text-center"><a href="#" ${HRemove} class="text-danger"><i class="fas fa-times"></i></a></td>`
                                    + '</tr>';
                                $('#Tb_Staple').append(t)

                                $('#frmNoData').hide();
                                $('#frmStaple').show();
                            })

                            var HDelete = 'onclick=Delete();';
                            var a = '<tr>'
                                + '<td colspan = "3" class="text-right">ลบข้อมูลทั้งหมด</td >'
                                + `<td class="text-center table-danger"><a href="#" ${HDelete} class="text-white"><i class="fas fa-times"></i></a></td>`
                                + '</tr>';
                            $('#Tb_Staple').append(a)

                        } else {
                            Swal.fire({
                                text: "กรุณาเลือกวัตถุดิบ",
                                icon: 'warning'
                            })

                            $('#frmNoData').show();
                            $('#frmStaple').hide();
                        }

                    })
                }
            });

            $('#MadalStaple').modal('hide');
        }

        function Remove(id) {
            Swal.fire({
                text: "ต้องการลบหรือไม่ ?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
            }).then((result) => {
                if (result.value) {

                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("Remove", "FoodSub")',
                        dataType: 'json',
                        data: {id: id},
                        success: function (data) {
                            $.each(data, function (index, val) {
                                if (val.length > 0) {
                                    $('#Tb_Staple').empty();

                                    val.forEach(function (value) {
                                        var HRemove = 'onclick=Remove("' + value.stapleId + '");';

                                        var t = '<tr>'
                                            + '<td>' + value.stapleName + '</td>'
                                            + '<td class="text-center">' + value.amount + '</td>'
                                            + '<td class="text-center">' + value.unitName + '</td>'
                                            + `<td class="text-center"><a href="#" ${HRemove} class="text-danger"><i class="fas fa-times"></i></a></td>`
                                            + '</tr>';
                                        $('#Tb_Staple').append(t)

                                        $('#frmNoData').hide();
                                        $('#frmStaple').show();
                                    })

                                    var HDelete = 'onclick=Delete();';
                                    var a = '<tr>'
                                        + '<td colspan = "3" class="text-right">ลบข้อมูลทั้งหมด</td >'
                                        + `<td class="text-center table-danger"><a href="#" ${HDelete} class="text-white"><i class="fas fa-times"></i></a></td>`
                                        + '</tr>';
                                    $('#Tb_Staple').append(a)

                                } else {
                                    $('#frmNoData').show();
                                    $('#frmStaple').hide();
                                }
                            })
                        }
                    });
                }
            });
        }

        function Delete() {
            Swal.fire({
                text: "ต้องการลบทั้งหมดหรือไม่ ?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
            }).then((result) => {
                if (result.value) {

                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("Delete", "FoodSub")',
                        dataType: 'json',
                        success: function (data) {
                            $.each(data, function (index, val) {
                                $('#frmNoData').show();
                                $('#frmStaple').hide();
                            })

                            $('#Tb_Staple').empty();
                        }
                    });

                }
            });
        }

        $('#txtPrice').on('keypress', function () {
            if (event.keyCode < 48 || event.keyCode > 57) {
                Swal.fire({
                    text: "สามารถกดได้แค่ตัวเลข",
                    icon: 'warning'
                })

                event.returnValue = false;
            }
        })

        $('#txtPrice').on('blur', function () {
            var txt = numeral($('#txtPrice').val()).format('0,0.00');
            $('#txtPrice').val(txt);
        })

    </script>
}
